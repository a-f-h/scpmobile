<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SCP Mobile</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/solar/bootstrap.min.css" />
	<script src="./Scripts/jquery.js"></script>
	    <script src="./Scripts/quagga.js"></script>
    <script src="./Scripts/bootstrap.js"></script>
	 <script src="./Scripts/webrtc-adapter-latest.js"></script>

    <style>

        #wrapper {
            display: none;
            opacity: 0.0;
        }

        body {
            padding-top: 12px;
            padding-bottom: 6px;
        }

        .container {
            padding-left: 3px !important;
            padding-right: 3px !important;
        }

            .container.c-no-pad {
                margin-left: 1px !important;
                padding-left: 0px !important;
                padding-right: 0px !important;
            }

        video {
            overflow: visible !important;
        }

</style>
</head>
<body>
<div id="mainContainer" class="container c-no-pad">
    <div style="display:none;" id="hiddenJsonObj"></div>
    <div class="shadowBox">
        <div class="page-container">
            <div class="container">
                <div class="jumbotron">
                    <h2 class="text-success">Pallet Barcode Scan</h2>
                </div>
                <div class="well">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="bcInputContainer" style="display:-webkit-inline-box; margin-bottom:3em;">
                                <a id="getBarcodeBtn" class="btn btn-success"> START SCANNING <i class="glyphicon glyphicon-barcode" style="margin-left:6px; margin-top:4px;"></i></a>
                                <div id="bcInputView" style="height:240px !important; display:none">
                                    <video src=""></video>
                                    <canvas class="drawingBuffer" style=" margin-left:-23em;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="barcodeListViewContainer" style="margin-top:3em;">
                                <div style="display:flex">
                                    <strong class="PoLineDetailsHeader">
                                        Scanned Barcodes
                                    </strong>
                                    <strong id="scannedBarcodeCount" style="float:right; margin-left:35%; margin-top: 5px;">
                                        Count: 0
                                    </strong>
                                </div>
                                <div id="barcodeListView" class="jumbotron" style="margin-top:6px;">

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="margin-top:2em;">
                        <div class="col-md-6">
                            <div style="display:flex">
                                <a id="stopScanningBtn" class="btn btn-danger" style="display:none; margin-right:32%;"> STOP SCANNING </a>
                                <a id="saveBolBtn" class="btn btn-success"> Save BOL </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
  


</body>
</html>

<script>

        // global vars
        var initRequest = $.Deferred();
        var arrBarcodes = [];

        (function () {

            "use strict";
			var App = {
						init : function() {
							Quagga.init(this.state, function(err) {
								if (err) {
									console.log(err);
									return;
								}
								App.attachListeners();
								App.checkCapabilities();
								Quagga.start();
								 initRequest.resolve(true);
							});
						},
						checkCapabilities: function() {
							var track = Quagga.CameraAccess.getActiveTrack();
							var capabilities = {};
							if (typeof track.getCapabilities === 'function') {
								capabilities = track.getCapabilities();
							}
							this.applySettingsVisibility('zoom', capabilities.zoom);
							this.applySettingsVisibility('torch', capabilities.torch);
						},
						inputMapper: {
							inputStream: {
								constraints: function(value){
									if (/^(\d+)x(\d+)$/.test(value)) {
										var values = value.split('x');
										return {
											width: {min: parseInt(values[0])},
											height: {min: parseInt(values[1])}
										};
									}
									return {
										deviceId: value
									};
								}
							},
							numOfWorkers: function(value) {
								return parseInt(value);
							},
							  decoder: {
									readers: ["code_128_reader"],
									debug: {
										drawBoundingBox: false,
										showFrequency: false,
										drawScanline: false,
										showPattern: false
									}
								}
						},
						state: {
							inputStream: {
								type : "LiveStream",
								target: document.querySelector('#bcInputView'),
								 constraints: {
									width: 320,
									height: 240,
									facingMode: "environment"
								}
							},
							locator: {
								patchSize: "medium",
								halfSample: true
							},
							numOfWorkers: 2,
							frequency: 10,
							decoder: {
								readers : [{
									format: "code_128_reader",
									config: {}
								}]
							},
							locate: true
						},
						lastResult : null
			};

            $('#getBarcodeBtn').on('click', function () {

                App.init();

                $.when(initRequest).done(function (success) {
                    if (success === true) {
                       // $('#getBarcodeBtn').html("SCANNING...");
                        if ($('#bcInputView').css('display') == 'none') {
                            $('#bcInputView').css('display', 'block');
                        }
                        $('#getBarcodeBtn').css('display', 'none');
                        $('#stopScanningBtn').css('display', 'flex');
                    }
                    else {
                        $('#getBarcodeBtn').removeClass('btn-success');
                        $('#getBarcodeBtn').addClass('btn-danger');
                        $('#getBarcodeBtn').html("Camera N/A");
                        $('#bcInputView').css('display', 'none');
                    }
                });

            });

            $('#stopScanningBtn').on('click', function () {
                Quagga.stop();
                $('#bcInputView').css('display', 'none');
                $('#stopScanningBtn').css('display', 'none');
                $('#getBarcodeBtn').css('display', 'flex');
            });

        }());


        function initBarcode() {

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#bcInputView'),    // Or '#yourElement' (optional)
                    constraints: {
                        width: 320,
                        height: 240,
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: ["code_128_reader"],
                    debug: {
                        drawBoundingBox: false,
                        showFrequency: false,
                        drawScanline: false,
                        showPattern: false
                    }
                },
                locate: true,
                locator: {
                    halfSample: false,
                    patchSize: "large", // x-small, small, medium, large, x-large
                    debug: {
                        showCanvas: false,
                        showPatches: false,
                        showFoundPatches: false,
                        showSkeleton: false,
                        showLabels: false,
                        showPatchLabels: false,
                        showRemainingPatchLabels: false,
                        boxFromPatches: {
                            showTransformed: false,
                            showTransformedBox: false,
                            showBB: false
                        }
                    }
                },
                debug: true
            }, function (err) {
                if (err) {
                    console.log(err);
                    alert(err);
                    initRequest.resolve(false);
                    return;
                }
                else {
                    initRequest.resolve(true);
                }
                console.log("Initialization finished. Ready to start");
                Quagga.start();
            });

            Quagga.onDetected(onBarcodeDetected);

            Quagga.onProcessed(function (result) {
                var drawingCtx = Quagga.canvas.ctx.overlay,
                    drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                        result.boxes.filter(function (box) {
                            return box !== result.box;
                        }).forEach(function (box) {
                            Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, { color: "green", lineWidth: 2 });
                        });
                    }

                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, { color: "#00F", lineWidth: 2 });
                    }

                    if (result.codeResult && result.codeResult.code) {
                        Quagga.ImageDebug.drawPath(result.line, { x: 'x', y: 'y' }, drawingCtx, { color: 'red', lineWidth: 3 });
                    }
                }
            });


        }

        function onBarcodeDetected(obj) {
            // log raw
            console.log(obj);
            // get barcode
            var barcodevalue = obj.codeResult.code;
            console.log("Barcode Value: " + barcodevalue);

            // RegEx
            var mme = /^(?=.{8}$)RP{1}\d{6}/;
            var found = barcodevalue.match(mme);
            var f = found === null ? false : true;
            // f true means barcode matches the pattern
            if (f === true) {
                // check accuracy
                var acc = obj.codeResult.startInfo.error;
                if (acc <= 0.095) {
                    // accurracy good, add barcode to the list if the value has not already been added 
                    if (arrBarcodes.findIndex(b => (b === barcodevalue)) == -1) {
                        arrBarcodes.push(barcodevalue);
                        updateBarcodeListView(); // refresh
                    }
                    else {
                        console.log("barcode already scanned ##########################################################");
                    }
                }
                else {
                    console.log("Barcode Accuracy error too high! Acc = " + acc);
                }
            }
            else {
               console.log('Invalid Barcode Value Scanned: ' + barcodevalue + '\nError%: ' + obj.codeResult.startInfo.error);
            }
        }

        function updateBarcodeListView() {

            var bc = "";
            for (i = 0; i < arrBarcodes.length; i++) {
                var bcv = arrBarcodes[i].startsWith("RP") ? "default" : "danger";
                bc += ('<div class="btn btn-' + bcv + '" style="margin:4px;"><b>' + arrBarcodes[i] + ' </b><i id="bc-' + arrBarcodes[i] + '" class="glyphicon glyphicon-remove-circle" onclick="removeBarcode(this.id);"></i></div>');
            }
            $('#barcodeListView').html(bc);
            $('#scannedBarcodeCount').html("Count: " + arrBarcodes.length);
        }

        function removeBarcode(id) {
            console.log(id);
            var bc = id.substring(3, id.length);
            console.log("removing bc: " + bc);
            arrBarcodes.splice(arrBarcodes.findIndex(b => (b === bc)), 1);
            // refresh
            updateBarcodeListView();
        }

    </script>
